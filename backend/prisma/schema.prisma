generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// User Management
// ============================================

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  username     String   @unique
  passwordHash String
  avatarUrl    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  ownedRooms             Room[]            @relation("RoomOwner")
  roomParticipations     RoomParticipant[]
  sentFriendRequests     Friendship[]      @relation("FriendshipRequester")
  receivedFriendRequests Friendship[]      @relation("FriendshipAddressee")
  messages               ChatMessage[]
  uploadedVideos         Video[]
  refreshTokens          RefreshToken[]
  settings               UserSettings?
  reportsCreated         UserReport[]      @relation("ReportCreator")
  reportsReceived        UserReport[]      @relation("ReportTarget")

  @@index([email])
  @@index([username])
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

model UserSettings {
  id     String @id @default(cuid())
  userId String @unique

  // Voice settings
  voiceMode        String  @default("push_to_talk") // push_to_talk, voice_activity
  pttKey           String  @default("Space")
  vadThreshold     Float   @default(0.5) // 0.0 to 1.0
  noiseSuppression Boolean @default(true)
  echoCancellation Boolean @default(true)

  // UI settings
  soundEffectsEnabled   Boolean @default(true)
  notificationsEnabled  Boolean @default(true)

  // Display settings
  theme String @default("dark") // dark, light, auto

  // Privacy settings
  forceRelay       Boolean @default(false) // Force TURN-only mode (hide IP)
  hideFromSearch   Boolean @default(false)
  blockNonFriends  Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ============================================
// Room Management
// ============================================

model Room {
  id              String   @id @default(cuid())
  code            String   @unique // 8-char invite code
  name            String
  ownerId         String
  maxParticipants Int      @default(5)
  passwordHash    String?
  playbackControl String   @default("owner_only") // owner_only, all, selected
  createdAt       DateTime @default(now())
  expiresAt       DateTime

  // Current video (optional)
  videoId String?
  video   Video?  @relation(fields: [videoId], references: [id])

  // YouTube source (if applicable)
  youtubeVideoId String?

  // External source URL (if applicable)
  externalUrl String?

  // Privacy preset: public, friends_only, private, anonymous
  privacyPreset String  @default("public")

  // Privacy settings (derived from preset or custom)
  allowAnonymous    Boolean @default(true)
  requireAuth       Boolean @default(false)
  showRealNames     Boolean @default(true)
  forceRelayMode    Boolean @default(false) // Force TURN-only connections

  // Relations
  owner        User              @relation("RoomOwner", fields: [ownerId], references: [id])
  participants RoomParticipant[]
  messages     ChatMessage[]
  reports      UserReport[]

  @@index([code])
  @@index([ownerId])
  @@index([expiresAt])
}

model RoomParticipant {
  id        String   @id @default(cuid())
  roomId    String
  oderId    String // Unique order ID for participant in room
  userId    String? // null for guests
  guestName String?
  role      String   @default("participant") // owner, participant, guest
  canControl Boolean @default(false) // for "selected" playback control
  joinedAt  DateTime @default(now())

  // Relations
  room Room  @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user User? @relation(fields: [userId], references: [id])

  @@unique([roomId, userId])
  @@unique([roomId, oderId])
  @@index([roomId])
}

// ============================================
// Video Management
// ============================================

model Video {
  id           String   @id @default(cuid())
  uploaderId   String
  filename     String
  originalSize BigInt // bytes
  mimeType     String
  duration     Int? // seconds
  status       String   @default("pending") // pending, processing, ready, failed
  progress     Int      @default(0) // 0-100
  errorMessage String?

  // Storage
  storageKey  String // key in MinIO
  manifestUrl String? // HLS manifest URL when ready

  // Metadata
  width  Int?
  height Int?

  createdAt DateTime @default(now())
  expiresAt DateTime

  // Relations
  uploader User   @relation(fields: [uploaderId], references: [id])
  rooms    Room[]

  @@index([uploaderId])
  @@index([status])
  @@index([expiresAt])
}

// ============================================
// Chat
// ============================================

model ChatMessage {
  id        String   @id @default(cuid())
  roomId    String
  userId    String? // null for system messages
  type      String   @default("user") // user, system
  content   String
  metadata  Json? // For system events: { kind, data }
  createdAt DateTime @default(now())

  // Relations
  room Room  @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user User? @relation(fields: [userId], references: [id])

  @@index([roomId, createdAt])
}

// ============================================
// Friends
// ============================================

model Friendship {
  id          String   @id @default(cuid())
  requesterId String
  addresseeId String
  status      String   @default("pending") // pending, accepted, blocked
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  requester User @relation("FriendshipRequester", fields: [requesterId], references: [id])
  addressee User @relation("FriendshipAddressee", fields: [addresseeId], references: [id])

  @@unique([requesterId, addresseeId])
  @@index([requesterId, status])
  @@index([addresseeId, status])
}

// ============================================
// Security & Audit Logging
// ============================================

model AuditLog {
  id         String   @id @default(cuid())
  timestamp  DateTime @default(now())
  eventType  String // e.g., 'room.created', 'auth.login', 'participant.kicked'
  actorId    String? // User who performed the action (null for system events)
  actorIp    String // IP address of the actor
  targetType String // 'room', 'user', 'video', 'system'
  targetId   String // ID of the target entity
  metadata   Json // Additional event-specific data
  success    Boolean  @default(true) // Whether the action succeeded

  @@index([timestamp])
  @@index([actorId])
  @@index([targetId])
  @@index([eventType])
  @@index([eventType, timestamp])
}

// ============================================
// Moderation & Abuse Protection
// ============================================

model UserReport {
  id              String   @id @default(cuid())
  reporterId      String
  reportedUserId  String
  roomId          String
  reason          String // harassment, inappropriate_content, spam, cheating, hate_speech, other
  description     String?
  evidence        Json? // { chatLogs: string[], timestamp: Date }
  status          String   @default("pending") // pending, reviewed, actioned, dismissed
  reviewedBy      String?
  reviewedAt      DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  reporter User @relation("ReportCreator", fields: [reporterId], references: [id])
  reported User @relation("ReportTarget", fields: [reportedUserId], references: [id])
  room     Room @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([reporterId])
  @@index([reportedUserId])
  @@index([roomId])
  @@index([status])
  @@index([createdAt])
}
