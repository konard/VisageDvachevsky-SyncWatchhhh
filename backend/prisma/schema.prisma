generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// User Management
// ============================================

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  username     String   @unique
  passwordHash String
  avatarUrl    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  ownedRooms             Room[]            @relation("RoomOwner")
  roomParticipations     RoomParticipant[]
  sentFriendRequests     Friendship[]      @relation("FriendshipRequester")
  receivedFriendRequests Friendship[]      @relation("FriendshipAddressee")
  messages               ChatMessage[]
  uploadedVideos         Video[]
  refreshTokens          RefreshToken[]
  settings               UserSettings?

  @@index([email])
  @@index([username])
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

model UserSettings {
  id     String @id @default(cuid())
  userId String @unique

  // Voice settings
  voiceMode        String  @default("push_to_talk") // push_to_talk, voice_activity
  pttKey           String  @default("Space")
  vadThreshold     Float   @default(0.5) // 0.0 to 1.0
  noiseSuppression Boolean @default(true)
  echoCancellation Boolean @default(true)

  // UI settings
  soundEffectsEnabled   Boolean @default(true)
  notificationsEnabled  Boolean @default(true)

  // Display settings
  theme String @default("dark") // dark, light, auto

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ============================================
// Room Management
// ============================================

model Room {
  id              String   @id @default(cuid())
  code            String   @unique // 8-char invite code
  name            String
  ownerId         String
  maxParticipants Int      @default(5)
  passwordHash    String?
  playbackControl String   @default("owner_only") // owner_only, all, selected
  ownerLock       Boolean  @default(true) // Prevent owner from being kicked
  createdAt       DateTime @default(now())
  expiresAt       DateTime
  lastActivityAt  DateTime @default(now()) // For idle room detection

  // Current video (optional)
  videoId String?
  video   Video?  @relation(fields: [videoId], references: [id])

  // YouTube source (if applicable)
  youtubeVideoId String?

  // External source URL (if applicable)
  externalUrl String?

  // Relations
  owner             User                @relation("RoomOwner", fields: [ownerId], references: [id])
  participants      RoomParticipant[]
  messages          ChatMessage[]
  temporaryHosts    TemporaryHost[]
  playbackVotes     PlaybackVote[]
  participantMetrics ParticipantMetrics[]
  historyEntries    RoomHistory[]

  @@index([code])
  @@index([ownerId])
  @@index([expiresAt])
  @@index([lastActivityAt])
}

model RoomParticipant {
  id        String   @id @default(cuid())
  roomId    String
  oderId    String // Unique order ID for participant in room
  userId    String? // null for guests
  guestName String?
  role      String   @default("participant") // owner, participant, guest
  canControl Boolean @default(false) // for "selected" playback control
  joinedAt  DateTime @default(now())

  // Relations
  room Room  @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user User? @relation(fields: [userId], references: [id])

  @@unique([roomId, userId])
  @@unique([roomId, oderId])
  @@index([roomId])
}

// ============================================
// Video Management
// ============================================

model Video {
  id           String   @id @default(cuid())
  uploaderId   String
  filename     String
  originalSize BigInt // bytes
  mimeType     String
  duration     Int? // seconds
  status       String   @default("pending") // pending, processing, ready, failed
  progress     Int      @default(0) // 0-100
  errorMessage String?

  // Storage
  storageKey  String // key in MinIO
  manifestUrl String? // HLS manifest URL when ready

  // Metadata
  width  Int?
  height Int?

  createdAt DateTime @default(now())
  expiresAt DateTime

  // Relations
  uploader User   @relation(fields: [uploaderId], references: [id])
  rooms    Room[]

  @@index([uploaderId])
  @@index([status])
  @@index([expiresAt])
}

// ============================================
// Chat
// ============================================

model ChatMessage {
  id        String   @id @default(cuid())
  roomId    String
  userId    String? // null for system messages
  type      String   @default("user") // user, system
  content   String
  metadata  Json? // For system events: { kind, data }
  createdAt DateTime @default(now())

  // Relations
  room Room  @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user User? @relation(fields: [userId], references: [id])

  @@index([roomId, createdAt])
}

// ============================================
// Friends
// ============================================

model Friendship {
  id          String   @id @default(cuid())
  requesterId String
  addresseeId String
  status      String   @default("pending") // pending, accepted, blocked
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  requester User @relation("FriendshipRequester", fields: [requesterId], references: [id])
  addressee User @relation("FriendshipAddressee", fields: [addresseeId], references: [id])

  @@unique([requesterId, addresseeId])
  @@index([requesterId, status])
  @@index([addresseeId, status])
}

// ============================================
// Security & Audit Logging
// ============================================

model AuditLog {
  id         String   @id @default(cuid())
  timestamp  DateTime @default(now())
  eventType  String // e.g., 'room.created', 'auth.login', 'participant.kicked'
  actorId    String? // User who performed the action (null for system events)
  actorIp    String // IP address of the actor
  targetType String // 'room', 'user', 'video', 'system'
  targetId   String // ID of the target entity
  metadata   Json // Additional event-specific data
  success    Boolean  @default(true) // Whether the action succeeded

  @@index([timestamp])
  @@index([actorId])
  @@index([targetId])
  @@index([eventType])
  @@index([eventType, timestamp])
}

// ============================================
// Smart Ownership & Room Lifecycle
// ============================================

// Temporary Host Sessions
model TemporaryHost {
  id              String   @id @default(cuid())
  roomId          String
  permanentOwnerId String
  temporaryHostId String
  grantedAt       DateTime @default(now())
  expiresAt       DateTime? // null = until revoked
  permissions     Json // Array of HostPermission strings
  revoked         Boolean  @default(false)

  // Relations
  room Room @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@unique([roomId, temporaryHostId])
  @@index([roomId])
  @@index([temporaryHostId])
  @@index([expiresAt])
}

// Playback Voting System
model PlaybackVote {
  id           String   @id @default(cuid())
  roomId       String
  type         String // 'pause' | 'resume'
  initiatedBy  String
  initiatedAt  DateTime @default(now())
  expiresAt    DateTime
  threshold    Int // Number of votes needed to pass
  votes        Json // Map of userId to 'yes' | 'no'
  resolved     Boolean  @default(false)
  passed       Boolean  @default(false)

  // Relations
  room Room @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([roomId])
  @@index([resolved])
  @@index([expiresAt])
}

// Participant Network Metrics for Auto-Host Selection
model ParticipantMetrics {
  id                String   @id @default(cuid())
  roomId            String
  userId            String
  avgLatencyMs      Float    @default(0)
  packetLossPercent Float    @default(0)
  connectionUptime  BigInt   @default(0) // milliseconds
  stabilityScore    Float    @default(0) // Computed score
  lastUpdated       DateTime @default(now())

  // Relations
  room Room @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@unique([roomId, userId])
  @@index([roomId])
  @@index([userId])
}

// Scheduled Rooms
model ScheduledRoom {
  id            String   @id @default(cuid())
  creatorId     String
  scheduledFor  DateTime
  timezone      String   @default("UTC")
  name          String
  code          String   @unique // Pre-generated invite code
  maxParticipants Int    @default(5)
  passwordHash  String?
  playbackControl String @default("owner_only")

  // Video source (optional, can be set later)
  videoId        String?
  youtubeVideoId String?
  externalUrl    String?

  // Lifecycle
  status         String   @default("scheduled") // scheduled, active, cancelled, expired
  remindersSent  Boolean  @default(false)
  invitedUsers   Json     @default("[]") // Array of user IDs

  // Activation
  activatedRoomId String? // ID of the actual Room when activated

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([creatorId])
  @@index([scheduledFor])
  @@index([status])
  @@index([code])
}

// Room Watch History
model RoomHistory {
  id              String   @id @default(cuid())
  roomId          String
  userId          String
  roomName        String

  // Source information
  sourceType      String // 'upload', 'youtube', 'external'
  sourceData      Json // Stores video metadata or URL

  // Session data
  watchedAt       DateTime @default(now())
  watchDurationMs BigInt // How long the user watched
  participants    Json // Array of participant names/IDs
  thumbnail       String? // Thumbnail URL if available

  // Privacy
  isVisible       Boolean  @default(true) // User can hide history entries

  // Relations
  room Room @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([userId, watchedAt])
  @@index([roomId])
}

// Room Templates
model RoomTemplate {
  id        String   @id @default(cuid())
  userId    String
  name      String
  isDefault Boolean  @default(false)
  settings  Json // RoomSettings object
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([userId, isDefault])
}
