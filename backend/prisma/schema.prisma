generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// User Management
// ============================================

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  username     String   @unique
  passwordHash String
  avatarUrl    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  ownedRooms             Room[]            @relation("RoomOwner")
  roomParticipations     RoomParticipant[]
  sentFriendRequests     Friendship[]      @relation("FriendshipRequester")
  receivedFriendRequests Friendship[]      @relation("FriendshipAddressee")
  messages               ChatMessage[]
  uploadedVideos         Video[]
  refreshTokens          RefreshToken[]
  settings               UserSettings?

  @@index([email])
  @@index([username])
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

model UserSettings {
  id     String @id @default(cuid())
  userId String @unique

  // Voice settings
  voiceMode        String  @default("push_to_talk") // push_to_talk, voice_activity
  pttKey           String  @default("Space")
  vadThreshold     Float   @default(0.5) // 0.0 to 1.0
  noiseSuppression Boolean @default(true)
  echoCancellation Boolean @default(true)

  // UI settings
  soundEffectsEnabled   Boolean @default(true)
  notificationsEnabled  Boolean @default(true)

  // Display settings
  theme String @default("dark") // dark, light, auto

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ============================================
// Room Management
// ============================================

model Room {
  id              String   @id @default(cuid())
  code            String   @unique // 8-char invite code
  name            String
  ownerId         String
  maxParticipants Int      @default(5)
  passwordHash    String?
  playbackControl String   @default("owner_only") // owner_only, all, selected
  createdAt       DateTime @default(now())
  expiresAt       DateTime

  // Current video (optional)
  videoId String?
  video   Video?  @relation(fields: [videoId], references: [id])

  // YouTube source (if applicable)
  youtubeVideoId String?

  // External source URL (if applicable)
  externalUrl String?

  // Relations
  owner        User              @relation("RoomOwner", fields: [ownerId], references: [id])
  participants RoomParticipant[]
  messages     ChatMessage[]

  @@index([code])
  @@index([ownerId])
  @@index([expiresAt])
}

model RoomParticipant {
  id        String   @id @default(cuid())
  roomId    String
  oderId    String // Unique order ID for participant in room
  userId    String? // null for guests
  guestName String?
  role      String   @default("participant") // owner, participant, guest
  canControl Boolean @default(false) // for "selected" playback control
  joinedAt  DateTime @default(now())

  // Relations
  room Room  @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user User? @relation(fields: [userId], references: [id])

  @@unique([roomId, userId])
  @@unique([roomId, oderId])
  @@index([roomId])
}

// ============================================
// Video Management
// ============================================

model Video {
  id           String   @id @default(cuid())
  uploaderId   String
  filename     String
  originalSize BigInt // bytes
  mimeType     String
  duration     Int? // seconds
  status       String   @default("pending") // pending, processing, ready, failed
  progress     Int      @default(0) // 0-100
  errorMessage String?

  // Storage
  storageKey  String // key in MinIO
  manifestUrl String? // HLS manifest URL when ready

  // Metadata
  width  Int?
  height Int?

  createdAt DateTime @default(now())
  expiresAt DateTime

  // Relations
  uploader User   @relation(fields: [uploaderId], references: [id])
  rooms    Room[]

  @@index([uploaderId])
  @@index([status])
  @@index([expiresAt])
}

// ============================================
// Chat
// ============================================

model ChatMessage {
  id        String   @id @default(cuid())
  roomId    String
  userId    String? // null for system messages
  type      String   @default("user") // user, system
  content   String
  metadata  Json? // For system events: { kind, data }
  createdAt DateTime @default(now())

  // Relations
  room Room  @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user User? @relation(fields: [userId], references: [id])

  @@index([roomId, createdAt])
}

// ============================================
// Friends
// ============================================

model Friendship {
  id          String   @id @default(cuid())
  requesterId String
  addresseeId String
  status      String   @default("pending") // pending, accepted, blocked
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  requester User @relation("FriendshipRequester", fields: [requesterId], references: [id])
  addressee User @relation("FriendshipAddressee", fields: [addresseeId], references: [id])

  @@unique([requesterId, addresseeId])
  @@index([requesterId, status])
  @@index([addresseeId, status])
}

// ============================================
// Security & Audit Logging
// ============================================

model AuditLog {
  id         String   @id @default(cuid())
  timestamp  DateTime @default(now())
  eventType  String // e.g., 'room.created', 'auth.login', 'participant.kicked'
  actorId    String? // User who performed the action (null for system events)
  actorIp    String // IP address of the actor
  targetType String // 'room', 'user', 'video', 'system'
  targetId   String // ID of the target entity
  metadata   Json // Additional event-specific data
  success    Boolean  @default(true) // Whether the action succeeded

  @@index([timestamp])
  @@index([actorId])
  @@index([targetId])
  @@index([eventType])
  @@index([eventType, timestamp])
}

// ============================================
// Product Analytics
// ============================================

model AnalyticsEvent {
  id        String   @id @default(cuid())
  timestamp DateTime @default(now())

  // Session identification
  sessionId String   // Unique per user session
  userId    String?  // null for guests
  roomId    String?  // null for non-room events

  // Event classification
  eventName String   // e.g., 'session.start', 'sync.play', 'voice.join'
  category  String   // 'session', 'sync', 'voice', 'chat', 'funnel'

  // Event data
  properties Json     // Event-specific properties

  // User agent and platform
  userAgent String?
  platform  String?  // 'web', 'mobile'

  @@index([timestamp])
  @@index([sessionId])
  @@index([userId, timestamp])
  @@index([roomId, timestamp])
  @@index([eventName, timestamp])
  @@index([category, timestamp])
}

model SyncCorrectionLog {
  id        String   @id @default(cuid())
  timestamp DateTime @default(now())

  roomId    String
  userId    String?
  sessionId String

  // Correction details
  correctionType String // 'soft', 'hard'
  driftMs        Int    // Drift in milliseconds
  targetTimeMs   Int    // Target media time
  actualTimeMs   Int    // Actual media time before correction

  // Context
  videoSource String? // 'youtube', 'uploaded', 'external'
  playbackRate Float  @default(1.0)
  wasPlaying   Boolean

  @@index([roomId, timestamp])
  @@index([correctionType, timestamp])
  @@index([sessionId, timestamp])
}

model VoiceJoinAttempt {
  id        String   @id @default(cuid())
  timestamp DateTime @default(now())

  roomId    String
  userId    String?
  sessionId String

  // Join outcome
  success      Boolean
  failureReason String? // 'ice_failed', 'media_permission_denied', 'timeout', etc.
  joinTimeMs   Int?    // Time taken to successfully join (null if failed)

  // WebRTC diagnostics
  iceState         String? // 'new', 'checking', 'connected', 'completed', 'failed'
  candidatesCount  Int?
  turnUsed         Boolean @default(false)

  @@index([roomId, timestamp])
  @@index([success, timestamp])
  @@index([sessionId, timestamp])
}

model FunnelStep {
  id        String   @id @default(cuid())
  timestamp DateTime @default(now())

  sessionId String
  userId    String?

  // Funnel progression
  stepName  String   // 'visit', 'create_room', 'add_video', 'invite', 'play', 'complete'
  stepOrder Int      // 1, 2, 3, 4, 5, 6
  completed Boolean  @default(true)

  // Context
  roomId    String?
  metadata  Json?    // Additional step-specific data

  @@index([sessionId, stepOrder])
  @@index([stepName, timestamp])
  @@index([userId, timestamp])
}

// ============================================
// Diagnostics & Debug Logs
// ============================================

model DiagnosticsSnapshot {
  id        String   @id @default(cuid())
  timestamp DateTime @default(now())

  roomId    String
  userId    String?
  sessionId String

  // Network metrics
  latencyMs   Int?
  jitterMs    Int?
  packetLoss  Float?  // Percentage

  // Sync metrics
  serverTimeMs  BigInt
  localTimeMs   BigInt
  clockOffsetMs Int
  driftMs       Int
  bufferHealth  Float?  // 0.0 to 1.0
  playbackRate  Float

  // Voice metrics
  voiceState    String? // 'connected', 'disconnected', 'connecting'
  audioLevel    Float?  // 0.0 to 1.0
  iceState      String?

  // Socket metrics
  socketState       String  // 'connected', 'disconnected', 'reconnecting'
  reconnectAttempts Int     @default(0)

  @@index([roomId, timestamp])
  @@index([sessionId, timestamp])
}
